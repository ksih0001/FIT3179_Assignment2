{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Road Accident Deaths per 100,000 Population by Malaysian States (2018)",
    "fontSize": 30,
    "anchor": "start"
  },
  "width": 1000,
  "height": 600,
  "data": {
    "url": "js/geoBoundaries-MYS-ADM0.topojson",
    "format": {
      "type": "topojson",
      "feature": "states"
    }
  },
  "transform": [
    {
      "calculate": "datum.properties.Name == 'Penang' ? 'PULAU PINANG' : datum.properties.Name == 'Kuala Lumpur' ? 'W.P. KUALA LUMPUR' : datum.properties.Name == 'Johor' ? 'JOHOR' : upper(datum.properties.Name)",
      "as": "state_mapped"
    },
    {
      "lookup": "state_mapped",
      "from": {
        "data": {
          "url": "data/Total Death by State.csv"
        },
        "key": "State",
        "fields": ["2018"]
      }
    },
    {
      "calculate": "datum.properties.Name == 'Penang' ? 'PULAU PINANG' : datum.properties.Name == 'Kuala Lumpur' ? 'W.P. KUALA LUMPUR' : datum.properties.Name == 'Johor' ? 'Johor' : upper(datum.properties.Name)",
      "as": "state_for_population"
    },
    {
      "lookup": "state_for_population",
      "from": {
        "data": {
          "url": "data/population_2018.csv"
        },
        "key": "state",
        "fields": ["population"]
      }
    },
    {
      "calculate": "toNumber(replace(datum['2018'], ',', ''))",
      "as": "deaths_2018"
    },
    {
      "calculate": "(datum.deaths_2018 / (datum.population * 1000)) * 100000",
      "as": "deaths_per_100k"
    }
  ],
  "projection": {
    "type": "mercator",
    "center": [108, 2.0],
    "scale": 3000
  },
  "mark": {
    "type": "geoshape",
    "stroke": "white",
    "strokeWidth": 1
  },
  "encoding": {
    "color": {
      "field": "deaths_per_100k",
      "type": "quantitative",
      "scale": {
        "type": "threshold",
        "domain": [15, 20, 25, 30],
        "scheme": "oranges"
      },
      "legend": {
        "title": "Deaths per 100,000 Population",
        "orient": "bottom-right",
        "titleFontSize": 12,
        "labelFontSize": 12,
        "offset": 50,
        "titleAnchor": "start",
        "legendY": 500
      }
    },
    "tooltip": [
      {"field": "properties.Name", "type": "nominal", "title": "State"},
      {"field": "deaths_2018", "type": "quantitative", "title": "Total Deaths (2018)", "format": ","},
      {"field": "population", "type": "quantitative", "title": "Population (thousands)", "format": ","},
      {"field": "deaths_per_100k", "type": "quantitative", "title": "Deaths per 100,000", "format": ".1f"}
    ]
  }
}